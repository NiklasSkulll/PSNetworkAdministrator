# ------------------------------
# module "PSNetworkAdministrator"
# generated by: Niklas Schneider
# generated on: 02.02.2026
# ------------------------------

# === dot-source all private, public and service functions ===
try {
    Get-ChildItem -Path "$PSScriptRoot\Private\*.ps1" | ForEach-Object {
        . $_.FullName
    }
    Get-ChildItem -Path "$PSScriptRoot\Public\*.ps1" -ErrorAction Stop | ForEach-Object {
        . $_.FullName
    }
    Get-ChildItem -Path "$PSScriptRoot\Services\*.ps1" -ErrorAction Stop | ForEach-Object {
        . $_.FullName
    }
}
catch {
    throw "Failed to dot-source all private, public and service functions: $($_.Exception.Message)"
}

# === check module availability: CredentialManager, ActiveDirectory ===
if (-not (Get-Module -ListAvailable -Name CredentialManager)) {
    throw "CredentialManager module not found. Install Modul: Install-Module -Name CredentialManager -Force -Scope CurrentUser"
}
if (-not (Get-Module -ListAvailable -Name ActiveDirectory)) {
    Write-Warning "ActiveDirectory module not found. Install RSAT tools: Add-WindowsCapability -Online -Name Rsat.ActiveDirectory.DS-LDS.Tools~~~~0.0.1.0"
}

# === import modules: CredentialManager, ActiveDirectory ===
try {
    Import-Module CredentialManager -ErrorAction Stop
    Import-Module ActiveDirectory -ErrorAction Stop
}
catch {
    Write-Warning "Failed to import modules: $($_.Exception.Message)"
}

# === SQLite dependency ===

# variables for DB + dependencies folders
$script:DataRoot = Join-Path $PSScriptRoot 'Data'
$script:DBFolder = Join-Path $script:DataRoot 'db'
$script:DepsFolder = Join-Path $script:DataRoot 'deps'

# check if folders exist and create them
foreach ($DBPath in @($script:DBFolder, $script:DepsFolder)) {
    if (-not (Test-Path -LiteralPath $DBPath)) {
        New-Item -ItemType Directory -Path $DBPath -Force | Out-Null
    }
}

# default DB file path
$script:DBFilePath = Join-Path $script:DBFolder 'PSNetworkAdministrator.sqlite'

# load SQLite provider DLL
$script:SQLiteAvailable = $false
$SQLiteDll = Join-Path $script:DepsFolder 'Microsoft.Data.Sqlite.dll'

if (Test-Path -LiteralPath $SQLiteDll) {
    try {
        Add-Type -Path $SQLiteDll -ErrorAction Stop
        $script:SQLiteAvailable = $true
    }
    catch {
        $script:SQLiteAvailable = $false
        Write-Warning "Failed to load SQLite DLL from '$SQLiteDll': $($_.Exception.Message)"
    }
}
else {
    Write-Warning "SQLite DLL not found at '$SQLiteDll'. Put Microsoft.Data.Sqlite.dll (and any dependency DLLs) into Data\deps."
}

# load config and initialize the path and max logging size for logs
try {
    $script:ModuleConfig = Initialize-Configuration
    $script:LoggingPath = $script:ModuleConfig.Logging.LoggingPath
    $script:MaxLogSizeMB = $script:ModuleConfig.Logging.MaxLoggingSizeMB
}
catch {
    $script:LoggingPath = (Join-Path $PSScriptRoot "..\..\..\logs\PSNetAdmin.log")
    Write-Warning "Failed to load config, using default log path: $($script:LoggingPath)"
}